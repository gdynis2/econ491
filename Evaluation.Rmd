---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(tsibble)
library(fastDummies)
library(reshape2)
library(forecast)
setwd("~/Desktop/Econ491-Analysis/Walmart") #Change to your own working directory
```


```{r, include=TRUE}
df_validation = read_csv("validation_set.csv")

df_tx_val = df_validation %>% filter(state_id == 'TX')
df_tx_val = subset(df_tx_val, select = -c(state_id, snap_WI, snap_CA))

df_tx_val$month = month.name[df_tx_val$month]

df_tx_val = df_tx_val %>% 
            mutate(
              is_Christmas = ifelse(event_name_1 == 'Christmas', 1, 0),
              is_NewYear = ifelse(event_name_1 == 'NewYear', 1, 0),
              is_MothersDay = ifelse(event_name_1 == 'Mother\'s day', 1, 0),
              is_LaborDay = ifelse(event_name_1 == 'LaborDay', 1, 0),
              is_event = ifelse(event_name_1 != 'None' & !event_name_1 %in% 
                                  c("Christmas", "NewYear", "Mother\'s day", 
                                    "LaborDay"), 1, 0)
            )
df_tx_val= subset(df_tx_val, select = -c(month, year, event_name_1, event_name_2))

df_tx_val_1 = dummy_cols(df_tx_val, select_columns = c("weekday"))

df_tx_val_1 = subset(df_tx_val_1, select = -c(weekday))

rownames(df_tx_val_1) = df_tx_val_1$date
df_tx_val_1$date = NULL
```

```{r, include=TRUE}
#Replace NA's with 0

df_tx_val_1[is.na(df_tx_val_1)] <- 0

test_exogenous_vars <- df_tx_val_1[, setdiff(names(df_tx_val_1), c("total_sales", "weekday_Sunday"))]
test_exogenous_vars <- test_exogenous_vars %>%
  rename(mean_sell_price = avg_sell_price)


forecast_values <- forecast(model, xreg = as.matrix(test_exogenous_vars), h = nrow(df_tx_val_1))

predicted_values <- as.numeric(forecast_values$mean)
actual_values <- df_tx_val_1$total_sales
```

```{r, include=TRUE}
#### RMSE for test validation set
rmse <- sqrt(mean((actual_values - predicted_values)^2))

print(paste("Root Mean Squared Error (RMSE):", round(rmse, 4)))
```

```{r, include=TRUE}
#### Plotting actual vs predicted

plot_data <- data.frame(Actual = actual_values, Predicted = predicted_values)

# Plot predicted vs actual values
ggplot(plot_data, aes(x = Predicted, y = Actual)) +
  geom_point(color = "blue") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +  # 1:1 line for reference
  labs(title = "Predicted vs Actual Values",
       x = "Predicted Total Sales",
       y = "Actual Total Sales") +
  theme_minimal()
```

```{r, include=TRUE}
squared_errors <- (actual_values - predicted_values)^2

# Create a data frame for plotting
error_data <- data.frame(Index = 1:length(squared_errors), Squared_Error = squared_errors)

# Plot squared errors
ggplot(error_data, aes(x = Index, y = Squared_Error)) +
  geom_line() +  # Use geom_bar for a bar plot
  labs(title = "Squared Errors of Predictions",
       x = "Index",
       y = "Squared Error") +
  theme_minimal()
```
